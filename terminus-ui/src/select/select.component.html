<ts-form-field
  [validateOnChange]="validateOnChange"
  [control]="selfReference"
  [hideRequiredMarker]="hideRequiredMarker"
  [hint]="hint"
  [id]="id"
>
  <ts-label *ngIf="label">
    {{ label }}
  </ts-label>

  <!--
     -SELECT TRIGGER
     -->
    <div
      class="ts-select-trigger qa-select-trigger"
      [class.ts-select-trigger--hidden]="autocomplete"
      [attr.id]="autocomplete ? '' : id"
      [attr.tabindex]="tabIndex"
      cdk-overlay-origin
      aria-hidden="true"
      (click)="toggle()"
      #origin="cdkOverlayOrigin"
      #trigger
    >
      <div class="ts-select-value" [ngSwitch]="empty">
        <span
          class="ts-select-placeholder"
          *ngSwitchCase="true"
        >
          {{ placeholder || '\u00A0' }}
        </span>

        <span class="ts-select-value-text qa-select-value-text" *ngSwitchCase="false" [ngSwitch]="!!customTrigger">
          <span *ngSwitchDefault [attr.title]="selectTriggerValue">
            {{ selectTriggerValue || '\u00A0' }}
          </span>

          <ng-content select="ts-select-trigger" *ngSwitchCase="true"></ng-content>
        </span>
      </div>

      <div class="ts-select-arrow-wrapper qa-select-arrow-wrapper">
        <div class="ts-select-arrow"></div>
      </div>
    </div>


  <!--
     -AUTOCOMPLETE TRIGGER / CHIPS LIST
     -->
  <div
    class="ts-select__input-wrap"
    [class.ts-select__input-wrap--hidden]="!autocomplete"
  >

    <ng-container *ngIf="allowMultiple">
      <mat-chip-list #chipList="matChipList">
        <mat-chip
          *ngFor="let option of autocompleteFormControl.value"
          class="qa-autocomplete-chip"
          removable="true"
          (removed)="autocompleteDeselectItem(option)"
        >
          <span class="ts-autocomplete-chip-value" *ngIf="chipFormatUIFn">
            {{ retrieveValue(option, chipFormatUIFn) }}
          </span>
          <span class="ts-autocomplete-chip-value" *ngIf="!chipFormatUIFn">
            {{ option }}
          </span>
          <ts-icon matChipRemove>
            cancel
          </ts-icon>
        </mat-chip>

        <input
          class="ts-select__autocomplete-input qa-select-autocomplete-input"
          [matChipInputFor]="chipList"
          [tsAutocompleteTrigger]="auto"
          [reopenAfterSelection]="autocompleteReopenAfterSelection"
          [attr.id]="autocomplete ? id : ''"
          [attr.tabindex]="tabIndex"
          [(ngModel)]="searchQuery"
          (ngModelChange)="querySubject.next(searchQuery)"
          (blur)="handleInputBlur($event)"
          #input
        />

        <ng-template *ngTemplateOutlet="spinnerTemplate"></ng-template>
      </mat-chip-list>
    </ng-container>

    <ng-container *ngIf="!allowMultiple">
      <input
        class="ts-select__autocomplete-input qa-select-autocomplete-input"
        [tsAutocompleteTrigger]="auto"
        [attr.id]="autocomplete ? id : ''"
        [attr.tabindex]="tabIndex"
        [(ngModel)]="searchQuery"
        (ngModelChange)="querySubject.next(searchQuery)"
        (blur)="handleInputBlur($event)"
        #input
      />

      <ng-template *ngTemplateOutlet="spinnerTemplate"></ng-template>
    </ng-container>

  </div>
</ts-form-field>


<!--
   -SELECT PANEL
   -->
<ng-template
  *ngIf="!autocomplete"
  cdk-connected-overlay
  cdkConnectedOverlayLockPosition
  cdkConnectedOverlayHasBackdrop
  cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
  cdkConnectedOverlayOffsetX="0"
  [cdkConnectedOverlayOrigin]="origin"
  [cdkConnectedOverlayOpen]="panelOpen"
  [cdkConnectedOverlayPositions]="positions"
  [cdkConnectedOverlayMinWidth]="triggerRect?.width"
  [cdkConnectedOverlayWidth]="triggerRect?.width"
  [cdkConnectedOverlayOffsetY]="offsetY"
  [cdkConnectedOverlayFlexibleDimensions]="true"
  (backdropClick)="close()"
  (attach)="onAttached()"
  (detach)="close()"
>
  <div
    #panel
    class="ts-select-panel ts-{{ theme }} qa-select-panel"
    [class.ts-select-panel--multiple]="allowMultiple"
    [@transformPanel]="allowMultiple ? 'showing-multiple' : 'showing'"
    (@transformPanel.done)="panelDoneAnimatingStream.next($event.toState)"
    [style.transformOrigin]="transformOrigin"
    [style.font-size.px]="triggerFontSize"
    (keydown)="handleKeydown($event)"
  >
    <div
      class="ts-select-panel__toggle-all qa-select-toggle-all"
      (click)="toggleAllOptions()"
      *ngIf="allowMultiple && !autocomplete"
    >
      <ts-checkbox
        [isChecked]="allOptionsSelected"
        [isIndeterminate]="someOptionsSelected"
        theme="accent"
      >
        {{ someOptionsSelected ? 'Deselect' : 'Select' }} All

        <span
          class="ts-select-panel__count qa-select-selected-count"
          *ngIf="selectionModel?.selected.length"
        >
          {{ selectionModel?.selected.length }} selected
        </span>
      </ts-checkbox>
    </div>

    <!-- Outlet for options passed in by consumer -->
    <div *ngIf="isFilterable" class="ts-select-panel__filter-input">
      <ts-input label="filter..." [ngModel]="searchQuery" (ngModelChange)="queryChange.emit($event)"></ts-input>
    </div>
    <ng-template *ngTemplateOutlet="contentTemplate"></ng-template>
  </div>
</ng-template>


<!--
   -AUTOCOMPLETE PANEL
   -->
<ts-autocomplete-panel
  class="ts-select__autocomplete"
  #auto="tsAutocompletePanel"
  [id]="id + '-panel'"
  [options]="options"
  [optionGroups]="optionGroups"
  (optionSelected)="autocompleteSelectItem($event)"
>
  <!-- Outlet for options passed in by consumer -->
  <ng-template *ngTemplateOutlet="contentTemplate"></ng-template>
</ts-autocomplete-panel>




<ng-template #contentTemplate>
  <ng-content></ng-content>
</ng-template>

<ng-template #spinnerTemplate>
  <mat-progress-spinner
    *ngIf="showProgress"
    class="c-autocomplete__spinner c-autocomplete__spinner--{{theme}} qa-select-autocomplete-spinner"
    [ngClass]="{'c-autocomplete__spinner--active': showProgress}"
    diameter="21"
    mode="indeterminate"
  ></mat-progress-spinner>
</ng-template>

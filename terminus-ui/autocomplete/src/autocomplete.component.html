<ts-form-field
  [validateOnChange]="validateOnChange"
  [control]="selfReference"
  [hideRequiredMarker]="hideRequiredMarker"
  [hint]="hint"
  [id]="id"
  cdk-overlay-origin
  #origin="cdkOverlayOrigin"
>
  <ts-label *ngIf="label">
    {{ label }}
  </ts-label>

  <div
    class="ts-autocomplete__input-wrap"
  >

    <ng-container *ngIf="allowMultiple">
      <mat-chip-list #chipList="matChipList">
        <mat-chip
          *ngFor="let option of autocompleteFormControl.value"
          class="qa-autocomplete-chip"
          [removable]="true"
          (removed)="autocompleteDeselectItem(option)"
        >
          <span class="ts-autocomplete-chip-value">
            {{ chipFormatUIFn ? retrieveValue(option, chipFormatUIFn) : option }}
          </span>

          <ts-icon matChipRemove>
            cancel
          </ts-icon>
        </mat-chip>

        <input
          class="ts-autocomplete__input qa-select-autocomplete-input"
          [matChipInputFor]="chipList"
          [tsAutocompleteTrigger]="auto"
          [reopenAfterSelection]="reopenAfterSelection"
          [attr.id]="id"
          [(ngModel)]="searchQuery"
          (ngModelChange)="querySubject.next(searchQuery)"
          (blur)="handleInputBlur($event)"
          (keydown)="$event.stopPropagation()"
          #input
        />

        <ng-template *ngTemplateOutlet="spinnerTemplate"></ng-template>
      </mat-chip-list>
    </ng-container>

    <ng-container *ngIf="!allowMultiple">
      <input
        class="ts-autocomplete__input qa-select-autocomplete-input"
        [tsAutocompleteTrigger]="auto"
        [attr.id]="id"
        [(ngModel)]="searchQuery"
        (ngModelChange)="querySubject.next(searchQuery)"
        (blur)="handleInputBlur($event)"
        #input
      />

      <ng-template *ngTemplateOutlet="spinnerTemplate"></ng-template>
    </ng-container>

  </div>
</ts-form-field>


<ts-autocomplete-panel
  class="ts-autocomplete"
  #auto="tsAutocompletePanel"
  [id]="id + '-panel'"
  [options]="options"
  [optionGroups]="optionGroups"
  (optionSelected)="autocompleteSelectItem($event)"
>
  <!-- Outlet for options passed in by consumer -->
  <ng-template *ngTemplateOutlet="contentTemplate"></ng-template>
</ts-autocomplete-panel>


<ng-template #contentTemplate>
  <ng-content></ng-content>
</ng-template>

<ng-template #spinnerTemplate>
  <mat-progress-spinner
    *ngIf="showProgress"
    class="c-autocomplete__spinner c-autocomplete__spinner--{{theme}} qa-select-autocomplete-spinner"
    [ngClass]="{'c-autocomplete__spinner--active': showProgress}"
    diameter="21"
    mode="indeterminate"
  ></mat-progress-spinner>
</ng-template>